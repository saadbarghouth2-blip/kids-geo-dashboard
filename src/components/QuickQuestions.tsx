import { useMemo } from "react";
import type { Lesson, Place } from "../types";
import { normalizeArabic } from "../utils/text";

function findPlace(lesson: Lesson, q: string): Place | null {
    const nq = normalizeArabic(q);
    for (const p of lesson.places) {
        const name = normalizeArabic(p.title);
        if (name && nq.includes(name)) return p;
        for (const a of p.aliases ?? []) {
            const na = normalizeArabic(a);
            if (na && nq.includes(na)) return p;
        }
    }
    const tokens = nq.split(/\s+/).filter(Boolean).filter((t) => t.length >= 3);
    if (!tokens.length) return null;
    let best: { p: Place; score: number } | null = null;
    for (const p of lesson.places) {
        const hay = normalizeArabic(`${p.title} ${(p.aliases ?? []).join(" ")}`);
        const score = tokens.slice(0, 6).reduce((acc, t) => acc + (hay.includes(t) ? 1 : 0), 0);
        if (score >= 2 && (!best || score > best.score)) best = { p, score };
    }
    return best?.p ?? null;
}

export default function QuickQuestions(props: {
    lesson: Lesson;
    onNavigate: (placeId: string) => void;
    onToast: (title: string, body?: string) => void;
}) {
    const { lesson, onNavigate, onToast } = props;

    const quickChips = useMemo(() => {
        if (lesson.id === "projects")
            return [
                "ูุดุฑูุน ุงูุฏูุชุง ุงูุฌุฏูุฏุฉ ๐พ",
                "ุงูุนุงุตูุฉ ุงูุฅุฏุงุฑูุฉ ุงูุฌุฏูุฏุฉ ๐๏ธ",
                "ุชูุดูู ุงูุฎูุฑ ๐",
                "ูุดุฑูุน ุดุฑู ุงูุนูููุงุช ๐๏ธ",
                "ูุฏููุฉ ุงูุนูููู ุงูุฌุฏูุฏุฉ ๐",
                "ูุฏููุฉ ุงูุฌูุงูุฉ โฐ๏ธ",
                "ุจุฑูุฉ ุบูููู (ูุฏููุฉ ุงูุฃุณูุงู) ๐",
                "ูุทุงุฑ ุงูููููุฑูู ๐",
                "ุงููุทุงุฑ ุงูููุฑุจุงุฆู ุงูุณุฑูุน โก",
                "ูุญูุฑ ููุงุฉ ุงูุณููุณ ๐ข",
                "ูุดุฑูุน ุงูู 100 ุฃูู ุตูุจุฉ ๐ฑ",
                "ูุดุฑูุน ุงูู 1.5 ููููู ูุฏุงู ๐พ",
                "ููู ุงูุฏูุชุง ุงูุฌุฏูุฏุฉุ ๐บ๏ธ",
                "ููู ุงูุนุงุตูุฉ ุงูุฅุฏุงุฑูุฉุ ๐",
                "ููู ุชูุดููุ ๐ด",
                "ููู ุงูุนูููู ุงูุฌุฏูุฏุฉุ ๐๏ธ",
                "ููู ุงูุฌูุงูุฉุ ๐๏ธ",
                "ููู ููุงุฉ ุงูุณููุณุ ๐ณ๏ธ",
                "ููู ุงูููููุฑููุ ๐",
                "ููู ุงููุทุงุฑ ุงูููุฑุจุงุฆูุ ๐",
                "ูุนูู ุฅูู ุชูููุฉ ูุณุชุฏุงูุฉุ ๐ฑ",
                "ุฅูู ุฃุซุฑ ุงููุดุฑูุนุงุช ุงูููููุฉุ ๐",
                "ูุณุชูุจู ุงูุฒุฑุงุนุฉ ูู ูุตุฑ ๐",
                "ููู ุจูุจูู ูุฏู ุฌุฏูุฏุฉุ ๐๏ธ",
                "ุฅุฒุงู ูุญูู ุงูุจูุฆุฉุ ๐ณ",
                "ุงูุฃูู ุงูุบุฐุงุฆู ุงููุตุฑู ๐พ",
                "ุงูููู ุงูุฐูู ูู ูุตุฑ ๐",
                "ุงููุฏู ุงูุฐููุฉ ๐ป",
                "ุงูุตูุจ ุงูุฒุฑุงุนูุฉ ๐๏ธ",
                "ุงูุงุณุชุฒุฑุงุน ุงูุณููู ๐ฆ",
                "ุงุดุฑุญูู ุงูุฏุฑุณ ุจุจุณุงุทุฉ ๐",
            ];
        if (lesson.id === "minerals")
            return [
                "ูุฌูุน ุจูุจุงู ููุทุงูุฉ ุงูุดูุณูุฉ โ๏ธ",
                "ูุญุทุฉ ุงูุฒุนูุฑุงูุฉ ููุฑูุงุญ ๐ฌ๏ธ",
                "ููุฌู ุงูุณูุฑู (ุงูุฐูุจ) ๐ก",
                "ููุฌู ุฃุจู ุทุฑุทูุฑ (ุงูููุณูุงุช) โช",
                "ููุงุฌู ุญุฏูุฏ ุงููุงุญุงุช ุงูุจุญุฑูุฉ ๐ญ",
                "ุญูู ุธูุฑ (ุงูุบุงุฒ ุงูุทุจูุนู) ๐ฅ",
                "ุฃู ุจุฌูุฉ (ุงูููุฌููุฒ) ๐ชจ",
                "ุฌุจู ุงููุบุงุฑุฉ (ุงููุญู) โซ",
                "ุงูุฑูุงู ุงูุณูุฏุงุก (ุงูุจุฑูุณ) ๐ค",
                "ุงููุญุงุณ (ุงูุตุญุฑุงุก ุงูุดุฑููุฉ) ๐ถ",
                "ุงูุฑูุงู ุงูุจูุถุงุก (ุณููุงุก) โช",
                "ูุญุงุฌุฑ ุงูุฌุฑุงููุช (ุฃุณูุงู) ๐ฟ",
                "ููู ุจูุจุงูุ ๐",
                "ููู ุงูุฒุนูุฑุงูุฉุ ๐",
                "ููู ููุฌู ุงูุณูุฑูุ ๐ฐ",
                "ููู ุฃุจู ุทุฑุทูุฑุ ๐๏ธ",
                "ููู ุงููุงุญุงุช ุงูุจุญุฑูุฉุ โฐ๏ธ",
                "ููู ุญูู ุธูุฑุ ๐",
                "ููู ุฌุจู ุงููุบุงุฑุฉุ ๐๏ธ",
                "ููู ุงูุฑูุงู ุงูุณูุฏุงุกุ ๐๏ธ",
                "ููู ูุญุงุฌุฑ ุงูุฌุฑุงููุชุ ๐ชจ",
                "ุงุดุฑุญูู ุงูููุงุฑุฏ ุงููุนุฏููุฉ โ๏ธ",
                "ูุฑู ููุฒูุฉ ููุงููุฒูุฉุ ๐",
                "ุทุงูุฉ ูุชุฌุฏุฏุฉ ูู ูุตุฑุ โป๏ธ",
                "ูุตุฉ ุงูุฐูุจ ูู ูุตุฑ ๐บ",
                "ุฃูููุฉ ุงูููุณูุงุช ููุฒุฑุงุนุฉ ๐พ",
                "ุงูุบุงุฒ ุงูุทุจูุนู ูู ุงููุชูุณุท ๐",
                "ุฃูููุฉ ุงููุนุงุฏู ููุงูุชุตุงุฏ ๐",
                "ุฅุฒุงู ุจูุณุชุฎุฑุฌ ุงููุนุงุฏูุ ๐",
                "ุชุญููู ูุตุฑ ููุฑูุฒ ุทุงูุฉ โก",
                "ููู ุงูุทุงูุฉ ูููุฉุ ๐ก",
                "ุงููุนุงุฏู ูุงูุตูุงุนุงุช ุงูุซูููุฉ ๐จ",
                "ุญูุงูุฉ ุงูุซุฑูุฉ ุงููุนุฏููุฉ ๐ก๏ธ",
                "ูููุฒ ุจุงุทู ุงูุฃุฑุถ ๐",
            ];
        return [
            "ููุฑ ุงูููู (ุดุฑูุงู ุงูุญูุงุฉ) ๐ถ",
            "ุจุญูุฑุฉ ูุงุตุฑ ๐",
            "ุงูุณุฏ ุงูุนุงูู โก",
            "ุงูุจุญุฑ ุงููุชูุณุท ๐๏ธ",
            "ุงูุจุญุฑ ุงูุฃุญูุฑ ๐",
            "ุจุญูุฑุฉ ุงูุจุฑุฏููู ๐ฆ",
            "ูุญุทุฉ ุงูุญูุงู (ุงูุฏูุชุง ุงูุฌุฏูุฏุฉ) ๐๏ธ",
            "ูุญุทุฉ ุจุญุฑ ุงูุจูุฑ ๐ญ",
            "ุจุญูุฑุฉ ูุงุฑูู ๐ฆข",
            "ูุงุญุฉ ุณููุฉ (ุงูููุงู ุงูุฌูููุฉ) ๐ด",
            "ูุญุทุฉ ุชุญููุฉ ุงูุนูููู ๐ง",
            "ุชุฑุนุฉ ุงูุณูุงู ๐ฆ",
            "ูุงุฏู ุงูุฑูุงู ๐",
            "ุฏูุชุง ุงูููู ๐พ",
            "ุจุญูุฑุฉ ุงูุจุฑูุณ ๐",
            "ููู ููุฑ ุงููููุ ๐บ๏ธ",
            "ููู ุจุญูุฑุฉ ูุงุตุฑุ ๐",
            "ููู ุงูุณุฏ ุงูุนุงููุ ๐๏ธ",
            "ููู ุงูุจุญุฑ ุงููุชูุณุทุ ๐",
            "ููู ุงูุจุญุฑ ุงูุฃุญูุฑุ ๐๏ธ",
            "ููู ุจุญูุฑุฉ ูุงุฑููุ ๐ฆ",
            "ููู ูุงุฏู ุงูุฑูุงูุ ๐๏ธ",
            "ููู ุชุฑุนุฉ ุงูุณูุงูุ ๐ฆ",
            "ููู ูุญุทุฉ ุจุญุฑ ุงูุจูุฑุ ๐ญ",
            "ููู ูุญุทุฉ ุงูุญูุงูุ ๐๏ธ",
            "ููู ูุงุญุฉ ุณููุฉุ ๐ด",
            "ููู ุจุญูุฑุฉ ุงูุจุฑุฏูููุ ๐",
            "ููู ุฏูุชุง ุงููููุ ๐พ",
            "ุงุดุฑุญูู ูุตุงุฏุฑ ุงูููุงู ๐ง",
            "ุงููุฑู ุนุฐุจุฉ ููุงูุญุฉุ ๐",
            "ุฅูู ุงุณุชุฎุฏุงูุงุช ุงูููุงูุ ๐ฅ",
            "ุฅูู ูุดุงูู ุงูููุงูุ โ๏ธ",
            "ุฅุฒุงู ูุญุงูุธ ุนูู ุงูููุงูุ ๐ก๏ธ",
            "ุนุธูุฉ ุงูููู ูููุตุฑููู ๐ช๐ฌ",
            "ุชูููุฏ ุงูููุฑุจุงุก ูู ุงูููุงู ๐ก",
            "ูุญุทุงุช ุชุญููุฉ ุงูููุงู ๐ง",
            "ุฅุฒุงู ูุญูู ุงููููุ ๐งผ",
            "ุงูููุงู ููุณุชูุจู ูุตุฑ ๐",
        ];
    }, [lesson.id]);

    const handleQuestionClick = (question: string) => {
        const place = findPlace(lesson, question);
        if (place) {
            onNavigate(place.id);
            onToast("ุงูุชูุงู ููุฎุฑูุทุฉ", `ุฑููุญุชู ูู ${place.title}`);
        } else {
            onToast("ุณุคุงู", question);
        }
    };

    return (
        <div className="glass-deep rounded-[32px] p-5 shadow-2xl relative overflow-hidden h-full flex flex-col border border-white/10">
            <div className="glow-ring opacity-40" />

            <div className="flex items-center justify-between mb-4">
                <div className="zone-title !mb-0 text-sm">
                    <span className="w-1.5 h-1.5 rounded-full bg-cyan-400 shadow-glow animate-pulse" />
                    ุงููุณุงุนุฏ ุงูุฐูู (ุตูุช ุงูุฎุฑูุทุฉ)
                </div>
                <div className="badge !px-3">FlyTo โข AI</div>
            </div>

            <div className="text-sm text-white/70 mb-4 px-1">
                ุฃููุงู ุจู! ุงุฎุชุฑ ุฃู ุณุคุงู ูู ุงูุฃุณูู ูุฃูุง ููุฏูู ููููุงู ุนูู ุงูุฎุฑูุทุฉ ููุฑุงู! ๐โจ
            </div>

            <div className="flex-1 overflow-y-auto pr-1 custom-scrollbar">
                <div className="grid grid-cols-2 gap-2">
                    {quickChips.map((c) => (
                        <button
                            key={c}
                            className="btn text-[10px] px-3 py-2.5 leading-tight text-right hover:bg-white/10 transition-colors border-white/10 hover:border-white/20 hover:scale-[1.02] active:scale-[0.98]"
                            onClick={() => handleQuestionClick(c)}
                        >
                            {c}
                        </button>
                    ))}
                </div>
            </div>
        </div>
    );
}
